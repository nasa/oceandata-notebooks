# change USER
USER root

# FIXME: see https://github.com/docker/for-mac/issues/7440
RUN chown -R ${NB_USER}:${NB_USER} "/home/${NB_USER}/.cache"

# system configuration
RUN git config --system credential.helper 'cache --timeout 86400 --socket /tmp/git-credential-cache/socket' \
 && git config --system core.excludesFile '/etc/gitignore' \
 && echo 'core.[0-9]*' > /etc/gitignore \
 && sh -c 'echo "shopt -s globstar" > /etc/profile.d/globstar.sh'

# install OCSSW core files but not $OCSSWROOT/share or $OCSSWROOT/var
ARG OCSSWTAG=V2025.3
ARG OCSSWROOT=/opt/ocssw
ARG OCSSWROOT_PUBLIC=/home/${NB_USER}/shared-public/pace-hackweek/ocssw
ENV OCSSWROOT=${OCSSWROOT}
ADD https://oceandata.sci.gsfc.nasa.gov/manifest/install_ocssw ./
ADD https://oceandata.sci.gsfc.nasa.gov/manifest/manifest.py ./
RUN chmod +x install_ocssw \
 && ./install_ocssw --tag=${OCSSWTAG} -a odps --root --bin --opt --python \
 && rm install_ocssw manifest.py \
 && ln -s ${OCSSWROOT_PUBLIC}/var ${OCSSWROOT} \
 && ln -s ${OCSSWROOT_PUBLIC}/share ${OCSSWROOT} \
 && chown ${NB_USER}:${NB_USER} ${OCSSWROOT}/*.json ${OCSSWROOT}/python/*.json

# revert USER
USER ${NB_USER}

# install (locked) dependencies
COPY --chown=${NB_USER}:${NB_USER} src/conda-lock.yml ${REPO_DIR}/conda-lock.yml
RUN ${MAMBA_EXE} install --yes --log-level error --file "conda-lock.yml" --category notebooks \
 && ${MAMBA_EXE} install --yes --log-level error --file "conda-lock.yml" --category jupyter \
 && ${MAMBA_EXE} install --yes --log-level error --file "conda-lock.yml" --category container \
 && ${MAMBA_EXE} clean --yes --all --force-pkgs-dirs

# jupyter configuration
COPY --chown=${NB_USER}:${NB_USER} src/prefix/ ${NB_PYTHON_PREFIX}/

# ignore select Python warnings
# TODO: specifically cartopy.io.DownloadWarning
ENV PYTHONWARNINGS="ignore::FutureWarning,ignore:::cartopy.io"
